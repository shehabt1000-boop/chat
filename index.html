<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† â€” Ù…Ø­Ø¯Ø«</title>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.1/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --blue-1:#0ea5e9;
    --blue-2:#0b84bf;
    --bg:#f5f8fb;
    --card:#ffffff;
    --muted:#6b7280;
    --text:#052635;
    --accent:#06b6d4;
    --danger:#ef4444;
    --shadow: 0 8px 28px rgba(2,6,23,0.06);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;font-family:Inter, "Tahoma", Arial, sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  /* Topbar */
  .topbar{
    background:linear-gradient(90deg,var(--blue-1),var(--blue-2));
    color:#fff;padding:12px 14px;display:flex;align-items:center;gap:12px;position:relative;
    box-shadow:0 6px 18px rgba(11,132,191,0.08);
  }
  .hamburger{
    background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:8px 12px;border-radius:10px;font-size:18px;cursor:pointer;
  }
  .app-title{font-weight:800;font-size:18px;letter-spacing:0.2px}
  .topbar-sub{margin-left:auto;font-size:13px;opacity:0.95}
  /* menu dropdown */
  .menu-dropdown{position:absolute;top:56px;right:12px;background:var(--card);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;border:1px solid #e6f3fb;display:none;z-index:60}
  .menu-item{display:block;padding:14px 18px;border-bottom:1px solid #f1f7fb;background:transparent;color:var(--text);cursor:pointer;text-align:right;width:240px;font-weight:700}
  .menu-item:hover{background:#f0fbff}
  .menu-item:last-child{border-bottom:none}
  /* container */
  .container{max-width:1150px;margin:16px auto;padding:12px}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:16px;box-shadow:var(--shadow)}
  h2.section-title{margin:0 0 8px 0;font-size:20px;color:var(--blue-2);font-weight:800}
  h3.card-title{margin:0 0 10px 0;font-size:16px;color:var(--text);font-weight:700}
  .row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .col{flex:1}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px;font-weight:700}
  input,select,textarea,button{font-size:14px;padding:9px;border-radius:10px;border:1px solid #e6eef6;background:transparent;color:var(--text)}
  input::placeholder{color:#9aa6b3}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:9px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn.primary{background:var(--blue-1);color:#fff}
  .btn.positive{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:1px solid #e6eef6;color:var(--muted)}
  .btn.warn{background:#ffb020;color:#fff}
  .table-wrap{overflow:auto;border-radius:10px;border:1px solid #eef6fb;margin-top:8px;background:#fff}
  table{width:100%;border-collapse:collapse;min-width:700px}
  th,td{padding:12px;text-align:center;border-bottom:1px solid #f1f6fb;font-size:14px}
  thead th{background:#f0fbff;color:var(--muted);font-weight:800}
  tbody tr:nth-child(odd){background:#fbfcfe}
  .low{background:#fff6f6}
  .small{font-size:13px;color:var(--muted)}
  .ops{font-size:12px;color:var(--muted);text-align:right;display:block}
  /* clickable row */
  tr.clickable{cursor:pointer}
  tr.clickable:hover{background:#f0fbff}
  /* responsive */
  @media (max-width:920px){
    .row{flex-direction:column;align-items:stretch}
    .menu-dropdown{right:8px;left:8px}
    table{min-width:520px}
  }
  @media (max-width:520px){
    table{min-width:480px}
  }
</style>
</head>
<body>

  <div class="topbar" role="banner">
    <button id="menuBtn" class="hamburger" aria-expanded="false" aria-controls="menuDropdown">â˜°</button>
    <div class="app-title">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
    <div class="topbar-sub">ÙˆØ§Ø¬Ù‡Ø© ÙØ§ØªØ­Ø© â€” ØªØµÙ…ÙŠÙ… Ù…Ù†Ø³Ù‚</div>

    <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
      <div class="menu-item" data-page="tab-inv">ğŸ¬ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† & Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
      <div class="menu-item" data-page="tab-pur">â• Ø¥Ø¶Ø§ÙØ© (ÙˆØ§Ø±Ø¯)</div>
      <div class="menu-item" data-page="tab-sale">â– Ù…Ù†ØµØ±Ù (Ø®Ø±ÙˆØ¬ Ø¨Ø¶Ø§Ø¹Ø©)</div>
      <div class="menu-item" data-page="tab-exp">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
      <div class="menu-item" data-page="tab-rep">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    </div>
  </div>

  <div class="container">
    <!-- INVENTORY (merged with operations) -->
    <section id="tab-inv" class="card tab-content" style="display:block">
      <h2 class="section-title">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ùˆ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>

      <div class="row">
        <div class="col">
          <label>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</label>
          <input id="searchInventory" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬...">
        </div>
        <div style="width:140px">
          <label>ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© â‰¤</label>
          <input id="lowThreshold" type="number" min="0" value="3">
        </div>
        <div style="width:150px">
          <label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</label>
          <div class="controls">
            <button class="btn ghost" id="refreshInv">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn ghost" id="clearSearchInv">Ù…Ø³Ø­</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ø¹ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)</h3>
        <div class="table-wrap" role="region" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">
          <table id="tableInventory" aria-live="polite">
            <thead>
              <tr>
                <th>Ø§Ù„ØµÙ†Ù</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                <th>Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¢Ø®Ø± 3)</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:8px">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ØµÙ Ù„Ù…Ù„Ø¦Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ ØµÙØ­Ø© "Ù…Ù†ØµØ±Ù".</div>
      </div>
    </section>

    <!-- ADD (was Purchases) -->
    <section id="tab-pur" class="card tab-content" style="display:none">
      <h2 class="section-title">â• Ø¥Ø¶Ø§ÙØ© â€” ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ø±Ø¯ ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>

      <div class="card">
        <h3 class="card-title">ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¶Ø§ÙØ©</h3>
        <div class="row">
          <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="purName" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"></div>
          <div style="width:120px"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="purQty" type="number" min="1" value="1"></div>
          <div style="width:140px"><label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="purPrice" type="number" step="0.01" min="0" value="0"></div>
          <div style="width:150px;display:flex;align-items:end"><button class="btn primary" id="btnAddPur">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</button></div>
        </div>
        <div class="small">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</h3>
        <div class="table-wrap">
          <table id="tablePurchases"><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- OUT (was Sales) -->
    <section id="tab-sale" class="card tab-content" style="display:none">
      <h2 class="section-title">â– Ù…Ù†ØµØ±Ù â€” ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¨Ø¶Ø§Ø¹Ø©</h2>

      <div class="card">
        <h3 class="card-title">ØªØ³Ø¬ÙŠÙ„ Ù…Ù†ØµØ±Ù</h3>
        <div class="row">
          <div class="col">
            <label>Ø¨Ø­Ø« / Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
            <input id="saleFilter" placeholder="Ø§ÙƒØªØ¨ Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...">
            <select id="saleSelect" size="6" style="width:100%;margin-top:8px"></select>
          </div>
          <div style="width:120px"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="saleQty" type="number" min="1" value="1"></div>
          <div style="width:140px"><label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="salePrice" readonly></div>
          <div style="width:150px;display:flex;align-items:end"><button class="btn primary" id="btnAddSale">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†ØµØ±Ù</button></div>
        </div>
        <div class="small">Ø§Ø®ØªÙØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø«Ù… Ø§Ø¶ØºØ· "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†ØµØ±Ù".</div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†ØµØ±ÙØ§Øª</h3>
        <div class="table-wrap">
          <table id="tableSales"><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="tab-exp" class="card tab-content" style="display:none">
      <h2 class="section-title">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>

      <div class="card">
        <div class="row">
          <div class="col"><label>Ø§Ù„ÙˆØµÙ</label><input id="expDesc" placeholder="Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø±ØŒ ØµÙŠØ§Ù†Ø©"></div>
          <div style="width:160px"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="expAmount" type="number" step="0.01" min="0"></div>
          <div style="width:150px;display:flex;align-items:end"><button class="btn primary" id="btnAddExp">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
        <div class="table-wrap">
          <table id="tableExpenses"><thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="tab-rep" class="card tab-content" style="display:none">
      <h2 class="section-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>

      <div class="card">
        <div class="row">
          <div class="col"><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</label><div id="sumPurchases" class="small">0.00</div></div>
          <div class="col"><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†ØµØ±ÙØ§Øª</label><div id="sumSales" class="small">0.00</div></div>
          <div class="col"><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</label><div id="sumExpenses" class="small">0.00</div></div>
          <div class="col"><label>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ù…Ù†ØµØ±Ù âˆ’ Ø¥Ø¶Ø§ÙØ© âˆ’ Ù…ØµØ±ÙˆÙØ§Øª)</label><div id="netProfit" class="small">0.00</div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col"></div>
          <div style="width:260px;display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <button class="btn positive" id="exportExcelBtn">ØªØ­Ù…ÙŠÙ„ Excel</button>
            <button class="btn primary" id="exportPdfBtn">ØªØ­Ù…ÙŠÙ„ PDF</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3 class="card-title">Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
        <div class="table-wrap">
          <h4 class="small" style="padding:8px">Ø§Ù„Ù…Ù†ØµØ±ÙØ§Øª</h4>
          <table id="repSales"><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>

          <h4 class="small" style="padding:8px;margin-top:8px">Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</h4>
          <table id="repPurchases"><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>

          <h4 class="small" style="padding:8px;margin-top:8px">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4>
          <table id="repExpenses"><thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

  </div>

<script>
/* ===== state & storage ===== */
const KEY = 'inv_dashboard_merged_v3';
let state = { inventory:[], purchases:[], sales:[], expenses:[], invLog:[], lowThreshold:3 };
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function loadState(){ const r = localStorage.getItem(KEY); if(r){ try{ state = JSON.parse(r); }catch(e){ console.error(e); } } }
loadState();

/* ===== DOM refs ===== */
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
const menuItems = menuDropdown.querySelectorAll('.menu-item');
const searchInventory = document.getElementById('searchInventory');
const lowThresholdEl = document.getElementById('lowThreshold');

const tableInventoryBody = document.querySelector('#tableInventory tbody');
const tablePurchasesBody = document.querySelector('#tablePurchases tbody');
const tableSalesBody = document.querySelector('#tableSales tbody');
const tableExpensesBody = document.querySelector('#tableExpenses tbody');
const repSalesBody = document.querySelector('#repSales tbody');
const repPurchasesBody = document.querySelector('#repPurchases tbody');
const repExpensesBody = document.querySelector('#repExpenses tbody');

const saleSelect = document.getElementById('saleSelect');

/* ===== menu behavior ===== */
menuBtn.addEventListener('click', (e)=>{
  const open = menuDropdown.style.display === 'block';
  menuDropdown.style.display = open ? 'none' : 'block';
  menuBtn.setAttribute('aria-expanded', String(!open));
  menuDropdown.setAttribute('aria-hidden', String(open));
});
document.addEventListener('click', (e)=>{
  if(!menuDropdown.contains(e.target) && e.target !== menuBtn) {
    menuDropdown.style.display = 'none';
    menuBtn.setAttribute('aria-expanded','false');
    menuDropdown.setAttribute('aria-hidden','true');
  }
});
menuItems.forEach(mi=>{
  mi.addEventListener('click', ()=> {
    const page = mi.getAttribute('data-page');
    showTab(page);
    menuDropdown.style.display = 'none';
  });
});
function showTab(tabId){
  document.querySelectorAll('.tab-content').forEach(s=> s.style.display = 'none');
  const el = document.getElementById(tabId);
  if(el) el.style.display = 'block';
  window.scrollTo({top:0,behavior:'smooth'});
  if(tabId === 'tab-rep') renderReports();
}

/* ===== helpers ===== */
function now(){ return new Date().toLocaleString(); }
function findProduct(name){ if(!name) return null; return state.inventory.find(i => i.item.toLowerCase() === name.trim().toLowerCase()); }
function logInv(action,item,qty){ state.invLog.push({ action,item,qty,date: now() }); saveState(); renderInvLog(); }

/* ===== Inventory rendering & hits (merged with log) ===== */
function renderInventory(filter=''){
  tableInventoryBody.innerHTML = '';
  const q = (filter||'').toLowerCase();
  state.inventory.forEach(prod=>{
    if(q && !prod.item.toLowerCase().includes(q)) return;
    // get last 3 ops for this product
    const ops = state.invLog.filter(l=> l.item.toLowerCase() === prod.item.toLowerCase()).slice(-3).reverse();
    const opsHtml = ops.length ? ops.map(o=>`${o.action} (${o.qty}) â€” ${o.date.split(',')[0]}`).join('<br/>') : '<span class="small">Ù„Ø§ Ø¹Ù…Ù„ÙŠØ§Øª</span>';
    const status = prod.qty <= state.lowThreshold ? 'Ù‚Ù„ÙŠÙ„' : 'Ø¬ÙŠØ¯';
    const tr = document.createElement('tr');
    tr.classList.add('clickable');
    tr.setAttribute('data-item', prod.item);
    tr.innerHTML = `<td style="text-align:right">${prod.item}</td><td>${prod.qty}</td><td>${prod.price.toFixed(2)}</td><td style="text-align:left">${opsHtml}</td><td>${status}</td>`;
    // when click row -> prefills sale select and opens Out tab
    tr.addEventListener('click', ()=> {
      // open Out tab and select product
      showTab('tab-sale');
      renderSaleList(); // ensure list filled
      // select the option
      const sel = document.getElementById('saleSelect');
      for(let i=0;i<sel.options.length;i++){ if(sel.options[i].value === prod.item){ sel.selectedIndex = i; sel.onchange && sel.onchange(); break; } }
      window.scrollTo({top:0,behavior:'smooth'});
    });
    if(prod.qty <= state.lowThreshold) tr.classList.add('low');
    tableInventoryBody.appendChild(tr);
  });
  lowThresholdEl.value = state.lowThreshold;
  renderInvLog(); // maintain log table (hidden now but used elsewhere)
}
function renderInvLog(){
  // we'll keep log in memory; not a separate page (merged) â€” but keep a lightweight table for refer
  // (not shown separately in UI anymore)
  // no-op here or could render hidden debug
}

/* ===== Add new product (manual) ===== */
document.getElementById('btnAddPur').addEventListener('click', ()=>{ /* use same handler as purchases */ });
document.getElementById('btnAddNewProd')?.addEventListener('click', ()=>{}); // no separate newProd in this design (we treat additions as purchases)

/* ===== Purchases / Add (increase inventory) ===== */
document.getElementById('btnAddPur').addEventListener('click', ()=>{
  const name = document.getElementById('purName').value.trim();
  const qty = parseInt(document.getElementById('purQty').value) || 0;
  const price = parseFloat(document.getElementById('purPrice').value) || 0;
  if(!name || qty<=0){ alert('Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ©'); return; }
  const total = qty * price; const date = now();
  state.purchases.push({ item:name, qty, price, total, date });
  const prod = findProduct(name);
  if(prod){ prod.qty += qty; if(price>0) prod.price = price; }
  else{ state.inventory.push({ item:name, qty, price }); }
  // record operation in invLog (addition)
  state.invLog.push({ action:'Ø¥Ø¶Ø§ÙØ©', item:name, qty, date });
  saveState(); renderPurchases(); renderInventory(searchInventory.value.trim()); renderSaleList(); renderReports();
  document.getElementById('purName').value=''; document.getElementById('purQty').value='1'; document.getElementById('purPrice').value='0';
});
function renderPurchases(){
  tablePurchasesBody.innerHTML = '';
  state.purchases.slice().reverse().forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.item}</td><td>${p.qty}</td><td>${p.price.toFixed(2)}</td><td>${p.total.toFixed(2)}</td><td>${p.date}</td>`;
    tablePurchasesBody.appendChild(tr);
  });
}

/* ===== Out (decrease inventory) ===== */
document.getElementById('btnAddSale').addEventListener('click', ()=>{
  const selected = document.getElementById('saleSelect').value;
  const qty = parseInt(document.getElementById('saleQty').value) || 0;
  if(!selected || qty<=0){ alert('Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ù‹Ø§ ÙˆØ­Ø¯Ø¯ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©'); return; }
  const prod = findProduct(selected);
  if(!prod){ alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  if(prod.qty < qty){ alert('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'); return; }
  const price = prod.price || 0;
  const total = qty * price; const date = now();
  state.sales.push({ item:prod.item, qty, price, total, date });
  prod.qty -= qty;
  // record operation
  state.invLog.push({ action:'Ù…Ù†ØµØ±Ù', item:prod.item, qty, date });
  saveState(); renderSales(); renderInventory(searchInventory.value.trim()); renderSaleList(); renderReports();
  document.getElementById('saleQty').value='1'; document.getElementById('salePrice').value='';
});
function renderSales(){
  tableSalesBody.innerHTML = '';
  state.sales.slice().reverse().forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.item}</td><td>${s.qty}</td><td>${s.price.toFixed(2)}</td><td>${s.total.toFixed(2)}</td><td>${s.date}</td>`;
    tableSalesBody.appendChild(tr);
  });
}

/* sale select + filter + click sets price */
function renderSaleList(filter=''){
  const sel = document.getElementById('saleSelect');
  sel.innerHTML = '';
  state.inventory.forEach(p=>{
    if(filter && !p.item.toLowerCase().includes(filter.toLowerCase())) return;
    const opt = document.createElement('option');
    opt.value = p.item; opt.textContent = `${p.item} â€” (${p.qty})`;
    sel.appendChild(opt);
  });
  sel.onchange = ()=> {
    const p = findProduct(sel.value);
    document.getElementById('salePrice').value = p ? p.price.toFixed(2) : '';
  };
  if(sel.options.length>0){ sel.selectedIndex = 0; sel.onchange(); } else { document.getElementById('salePrice').value=''; }
}
document.getElementById('saleFilter').addEventListener('input', (e)=> renderSaleList(e.target.value.trim()));

/* ===== Expenses ===== */
document.getElementById('btnAddExp').addEventListener('click', ()=>{
  const desc = document.getElementById('expDesc').value.trim();
  const amount = parseFloat(document.getElementById('expAmount').value) || 0;
  if(!desc || amount<=0){ alert('Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…ØµØ±ÙˆÙ'); return; }
  const date = now();
  state.expenses.push({ desc, amount, date });
  saveState(); renderExpenses(); renderReports();
  document.getElementById('expDesc').value=''; document.getElementById('expAmount').value='';
});
function renderExpenses(){
  tableExpensesBody.innerHTML = '';
  state.expenses.slice().reverse().forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.desc}</td><td>${e.amount.toFixed(2)}</td><td>${e.date}</td>`;
    tableExpensesBody.appendChild(tr);
  });
}

/* ===== Reports render ===== */
function renderReports(){
  const sumSales = state.sales.reduce((s,x)=>s + (x.total||0), 0);
  const sumPurchases = state.purchases.reduce((s,x)=>s + (x.total||0), 0);
  const sumExpenses = state.expenses.reduce((s,x)=>s + (x.amount||0), 0);
  document.getElementById('sumSales').textContent = sumSales.toFixed(2);
  document.getElementById('sumPurchases').textContent = sumPurchases.toFixed(2);
  document.getElementById('sumExpenses').textContent = sumExpenses.toFixed(2);
  document.getElementById('netProfit').textContent = (sumSales - sumPurchases - sumExpenses).toFixed(2);

  repSalesBody.innerHTML = '';
  state.sales.slice().reverse().forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.item}</td><td>${s.qty}</td><td>${s.price.toFixed(2)}</td><td>${s.total.toFixed(2)}</td><td>${s.date}</td>`;
    repSalesBody.appendChild(tr);
  });
  repPurchasesBody.innerHTML = '';
  state.purchases.slice().reverse().forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.item}</td><td>${p.qty}</td><td>${p.price.toFixed(2)}</td><td>${p.total.toFixed(2)}</td><td>${p.date}</td>`;
    repPurchasesBody.appendChild(tr);
  });
  repExpensesBody.innerHTML = '';
  state.expenses.slice().reverse().forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.desc}</td><td>${e.amount.toFixed(2)}</td><td>${e.date}</td>`;
    repExpensesBody.appendChild(tr);
  });
}

/* ===== Export Excel & PDF ===== */
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  try{
    const wb = XLSX.utils.book_new();
    const invData = state.inventory.map(i=>({Ø§Ù„ØµÙ†Ù:i.item, Ø§Ù„ÙƒÙ…ÙŠØ©:i.qty, Ø³Ø¹Ø±_Ø§Ù„Ø¨ÙŠØ¹:i.price}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invData), 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
    const salesData = state.sales.map(s=>({Ø§Ù„ØµÙ†Ù:s.item, Ø§Ù„ÙƒÙ…ÙŠØ©:s.qty, Ø³Ø¹Ø±_Ø§Ù„ÙˆØ­Ø¯Ø©:s.price, Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ:s.total, Ø§Ù„ØªØ§Ø±ÙŠØ®:s.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesData), 'Ø§Ù„Ù…Ù†ØµØ±ÙØ§Øª');
    const purData = state.purchases.map(p=>({Ø§Ù„ØµÙ†Ù:p.item, Ø§Ù„ÙƒÙ…ÙŠØ©:p.qty, Ø³Ø¹Ø±_Ø§Ù„ÙˆØ­Ø¯Ø©:p.price, Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ:p.total, Ø§Ù„ØªØ§Ø±ÙŠØ®:p.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(purData), 'Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª');
    const expData = state.expenses.map(e=>({Ø§Ù„ÙˆØµÙ:e.desc, Ø§Ù„Ù…Ø¨Ù„Øº:e.amount, Ø§Ù„ØªØ§Ø±ÙŠØ®:e.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expData), 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');
    const logData = state.invLog.map(l=>({Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:l.action, Ø§Ù„ØµÙ†Ù:l.item, Ø§Ù„ÙƒÙ…ÙŠØ©:l.qty, Ø§Ù„ØªØ§Ø±ÙŠØ®:l.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(logData), 'Ø³Ø¬Ù„_Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
    XLSX.writeFile(wb, 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø®Ø²Ù†.xlsx');
  } catch(err){
    console.error(err); alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel');
  }
});

document.getElementById('exportPdfBtn').addEventListener('click', ()=>{
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    doc.setFontSize(14);
    doc.text('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù†', 40, 40);
    doc.setFontSize(10);
    doc.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString()}`, 40, 60);
    const sumSales = state.sales.reduce((s,x)=>s + (x.total||0), 0);
    const sumPurchases = state.purchases.reduce((s,x)=>s + (x.total||0), 0);
    const sumExpenses = state.expenses.reduce((s,x)=>s + (x.amount||0), 0);
    const profit = sumSales - sumPurchases - sumExpenses;
    doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØµØ±ÙØ§Øª: ${sumSales.toFixed(2)}`, 40, 90);
    doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª: ${sumPurchases.toFixed(2)}`, 40, 106);
    doc.text(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${sumExpenses.toFixed(2)}`, 40, 122);
    doc.text(`ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${profit.toFixed(2)}`, 40, 138);
    const salesRows = state.sales.slice().reverse().slice(0,80).map(s=>[s.item, s.qty.toString(), s.price.toFixed(2), s.total.toFixed(2), s.date]);
    doc.autoTable({ startY: 160, head:[['Ø§Ù„ØµÙ†Ù','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','Ø§Ù„ØªØ§Ø±ÙŠØ®']], body: salesRows, styles:{fontSize:9} });
    doc.save('ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø®Ø²Ù†.pdf');
  } catch(err){
    console.error(err); alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ PDF');
  }
});

/* ===== UI interactions & init ===== */
document.getElementById('lowThreshold').addEventListener('change', ()=>{
  state.lowThreshold = parseInt(document.getElementById('lowThreshold').value) || 0; saveState(); renderInventory();
});
document.getElementById('searchInventory').addEventListener('input', (e)=> renderInventory(e.target.value.trim()));
document.getElementById('clearSearchInv').addEventListener('click', ()=>{ document.getElementById('searchInventory').value=''; renderInventory(); });
document.getElementById('refreshInv').addEventListener('click', ()=> renderAll());
document.getElementById('saleFilter').addEventListener('input', (e)=> renderSaleList(e.target.value.trim()));

/* save periodically */
setInterval(()=> saveState(), 3000);

/* initial render */
function renderAll(){
  renderInventory();
  renderPurchases();
  renderSales();
  renderExpenses();
  renderReports();
  renderSaleList();
}
renderAll();

/* keyboard: close menu on Esc */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ menuDropdown.style.display = 'none'; menuBtn.setAttribute('aria-expanded','false'); } });

</script>
</body>
</html>