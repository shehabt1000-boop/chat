<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>نظام إدارة المخزون — محدث</title>

<!-- مكتبات التصدير -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.1/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --blue-1:#0ea5e9;
    --blue-2:#0b84bf;
    --bg:#f5f8fb;
    --card:#ffffff;
    --muted:#6b7280;
    --text:#052635;
    --accent:#06b6d4;
    --danger:#ef4444;
    --shadow: 0 8px 28px rgba(2,6,23,0.06);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;font-family:Inter, "Tahoma", Arial, sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  /* Topbar */
  .topbar{
    background:linear-gradient(90deg,var(--blue-1),var(--blue-2));
    color:#fff;padding:12px 14px;display:flex;align-items:center;gap:12px;position:relative;
    box-shadow:0 6px 18px rgba(11,132,191,0.08);
  }
  .hamburger{
    background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:8px 12px;border-radius:10px;font-size:18px;cursor:pointer;
  }
  .app-title{font-weight:800;font-size:18px;letter-spacing:0.2px}
  .topbar-sub{margin-left:auto;font-size:13px;opacity:0.95}
  /* menu dropdown */
  .menu-dropdown{position:absolute;top:56px;right:12px;background:var(--card);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;border:1px solid #e6f3fb;display:none;z-index:60}
  .menu-item{display:block;padding:14px 18px;border-bottom:1px solid #f1f7fb;background:transparent;color:var(--text);cursor:pointer;text-align:right;width:240px;font-weight:700}
  .menu-item:hover{background:#f0fbff}
  .menu-item:last-child{border-bottom:none}
  /* container */
  .container{max-width:1150px;margin:16px auto;padding:12px}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:16px;box-shadow:var(--shadow)}
  h2.section-title{margin:0 0 8px 0;font-size:20px;color:var(--blue-2);font-weight:800}
  h3.card-title{margin:0 0 10px 0;font-size:16px;color:var(--text);font-weight:700}
  .row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .col{flex:1}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px;font-weight:700}
  input,select,textarea,button{font-size:14px;padding:9px;border-radius:10px;border:1px solid #e6eef6;background:transparent;color:var(--text)}
  input::placeholder{color:#9aa6b3}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:9px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn.primary{background:var(--blue-1);color:#fff}
  .btn.positive{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:1px solid #e6eef6;color:var(--muted)}
  .btn.warn{background:#ffb020;color:#fff}
  .table-wrap{overflow:auto;border-radius:10px;border:1px solid #eef6fb;margin-top:8px;background:#fff}
  table{width:100%;border-collapse:collapse;min-width:700px}
  th,td{padding:12px;text-align:center;border-bottom:1px solid #f1f6fb;font-size:14px}
  thead th{background:#f0fbff;color:var(--muted);font-weight:800}
  tbody tr:nth-child(odd){background:#fbfcfe}
  .low{background:#fff6f6}
  .small{font-size:13px;color:var(--muted)}
  .ops{font-size:12px;color:var(--muted);text-align:right;display:block}
  /* clickable row */
  tr.clickable{cursor:pointer}
  tr.clickable:hover{background:#f0fbff}
  /* responsive */
  @media (max-width:920px){
    .row{flex-direction:column;align-items:stretch}
    .menu-dropdown{right:8px;left:8px}
    table{min-width:520px}
  }
  @media (max-width:520px){
    table{min-width:480px}
  }
</style>
</head>
<body>

  <div class="topbar" role="banner">
    <button id="menuBtn" class="hamburger" aria-expanded="false" aria-controls="menuDropdown">☰</button>
    <div class="app-title">نظام إدارة المخزون</div>
    <div class="topbar-sub">واجهة فاتحة — تصميم منسق</div>

    <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
      <div class="menu-item" data-page="tab-inv">🏬 المخزون & الأصناف</div>
      <div class="menu-item" data-page="tab-pur">➕ إضافة (وارد)</div>
      <div class="menu-item" data-page="tab-sale">➖ منصرف (خروج بضاعة)</div>
      <div class="menu-item" data-page="tab-exp">💸 المصروفات</div>
      <div class="menu-item" data-page="tab-rep">📊 التقارير</div>
    </div>
  </div>

  <div class="container">
    <!-- INVENTORY (merged with operations) -->
    <section id="tab-inv" class="card tab-content" style="display:block">
      <h2 class="section-title">المخزون و سجل العمليات</h2>

      <div class="row">
        <div class="col">
          <label>بحث في المنتجات</label>
          <input id="searchInventory" placeholder="ابحث باسم المنتج...">
        </div>
        <div style="width:140px">
          <label>تنبيه عند الكمية ≤</label>
          <input id="lowThreshold" type="number" min="0" value="3">
        </div>
        <div style="width:150px">
          <label>الإجراءات</label>
          <div class="controls">
            <button class="btn ghost" id="refreshInv">تحديث</button>
            <button class="btn ghost" id="clearSearchInv">مسح</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">قائمة المنتجات (مع أحدث العمليات)</h3>
        <div class="table-wrap" role="region" aria-label="قائمة المنتجات">
          <table id="tableInventory" aria-live="polite">
            <thead>
              <tr>
                <th>الصنف</th>
                <th>الكمية</th>
                <th>سعر البيع</th>
                <th>آخر العمليات (آخر 3)</th>
                <th>الحالة</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:8px">اضغط على أي صف لملئه تلقائيًا في صفحة "منصرف".</div>
      </div>
    </section>

    <!-- ADD (was Purchases) -->
    <section id="tab-pur" class="card tab-content" style="display:none">
      <h2 class="section-title">➕ إضافة — تسجيل وارد ورفع المخزون</h2>

      <div class="card">
        <h3 class="card-title">تسجيل إضافة</h3>
        <div class="row">
          <div class="col"><label>اسم المنتج</label><input id="purName" placeholder="اكتب الاسم أو اختر من المخزون"></div>
          <div style="width:120px"><label>الكمية</label><input id="purQty" type="number" min="1" value="1"></div>
          <div style="width:140px"><label>سعر الوحدة</label><input id="purPrice" type="number" step="0.01" min="0" value="0"></div>
          <div style="width:150px;display:flex;align-items:end"><button class="btn primary" id="btnAddPur">تأكيد الإضافة</button></div>
        </div>
        <div class="small">سيتم إضافة السجل وتحديث المخزون تلقائيًا.</div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">سجل الإضافات</h3>
        <div class="table-wrap">
          <table id="tablePurchases"><thead><tr><th>الصنف</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>التاريخ</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- OUT (was Sales) -->
    <section id="tab-sale" class="card tab-content" style="display:none">
      <h2 class="section-title">➖ منصرف — تسجيل خروج بضاعة</h2>

      <div class="card">
        <h3 class="card-title">تسجيل منصرف</h3>
        <div class="row">
          <div class="col">
            <label>بحث / اختر المنتج</label>
            <input id="saleFilter" placeholder="اكتب لفلترة القائمة...">
            <select id="saleSelect" size="6" style="width:100%;margin-top:8px"></select>
          </div>
          <div style="width:120px"><label>الكمية</label><input id="saleQty" type="number" min="1" value="1"></div>
          <div style="width:140px"><label>سعر الوحدة</label><input id="salePrice" readonly></div>
          <div style="width:150px;display:flex;align-items:end"><button class="btn primary" id="btnAddSale">تسجيل المنصرف</button></div>
        </div>
        <div class="small">اختَر من القائمة أو ابحث ثم اضغط "تسجيل المنصرف".</div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">سجل المنصرفات</h3>
        <div class="table-wrap">
          <table id="tableSales"><thead><tr><th>الصنف</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>التاريخ</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="tab-exp" class="card tab-content" style="display:none">
      <h2 class="section-title">💸 المصروفات</h2>

      <div class="card">
        <div class="row">
          <div class="col"><label>الوصف</label><input id="expDesc" placeholder="مثال: إيجار، صيانة"></div>
          <div style="width:160px"><label>المبلغ</label><input id="expAmount" type="number" step="0.01" min="0"></div>
          <div style="width:150px;display:flex;align-items:end"><button class="btn primary" id="btnAddExp">إضافة مصروف</button></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 class="card-title">سجل المصروفات</h3>
        <div class="table-wrap">
          <table id="tableExpenses"><thead><tr><th>الوصف</th><th>المبلغ</th><th>التاريخ</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="tab-rep" class="card tab-content" style="display:none">
      <h2 class="section-title">📊 التقارير</h2>

      <div class="card">
        <div class="row">
          <div class="col"><label>إجمالي قيمة الإضافات</label><div id="sumPurchases" class="small">0.00</div></div>
          <div class="col"><label>إجمالي قيمة المنصرفات</label><div id="sumSales" class="small">0.00</div></div>
          <div class="col"><label>إجمالي المصروفات</label><div id="sumExpenses" class="small">0.00</div></div>
          <div class="col"><label>صافي الربح (منصرف − إضافة − مصروفات)</label><div id="netProfit" class="small">0.00</div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col"></div>
          <div style="width:260px;display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <button class="btn positive" id="exportExcelBtn">تحميل Excel</button>
            <button class="btn primary" id="exportPdfBtn">تحميل PDF</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3 class="card-title">جداول التقرير</h3>
        <div class="table-wrap">
          <h4 class="small" style="padding:8px">المنصرفات</h4>
          <table id="repSales"><thead><tr><th>الصنف</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>التاريخ</th></tr></thead><tbody></tbody></table>

          <h4 class="small" style="padding:8px;margin-top:8px">الإضافات</h4>
          <table id="repPurchases"><thead><tr><th>الصنف</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>التاريخ</th></tr></thead><tbody></tbody></table>

          <h4 class="small" style="padding:8px;margin-top:8px">المصروفات</h4>
          <table id="repExpenses"><thead><tr><th>الوصف</th><th>المبلغ</th><th>التاريخ</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

  </div>

<script>
/* ===== state & storage ===== */
const KEY = 'inv_dashboard_merged_v3';
let state = { inventory:[], purchases:[], sales:[], expenses:[], invLog:[], lowThreshold:3 };
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function loadState(){ const r = localStorage.getItem(KEY); if(r){ try{ state = JSON.parse(r); }catch(e){ console.error(e); } } }
loadState();

/* ===== DOM refs ===== */
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
const menuItems = menuDropdown.querySelectorAll('.menu-item');
const searchInventory = document.getElementById('searchInventory');
const lowThresholdEl = document.getElementById('lowThreshold');

const tableInventoryBody = document.querySelector('#tableInventory tbody');
const tablePurchasesBody = document.querySelector('#tablePurchases tbody');
const tableSalesBody = document.querySelector('#tableSales tbody');
const tableExpensesBody = document.querySelector('#tableExpenses tbody');
const repSalesBody = document.querySelector('#repSales tbody');
const repPurchasesBody = document.querySelector('#repPurchases tbody');
const repExpensesBody = document.querySelector('#repExpenses tbody');

const saleSelect = document.getElementById('saleSelect');

/* ===== menu behavior ===== */
menuBtn.addEventListener('click', (e)=>{
  const open = menuDropdown.style.display === 'block';
  menuDropdown.style.display = open ? 'none' : 'block';
  menuBtn.setAttribute('aria-expanded', String(!open));
  menuDropdown.setAttribute('aria-hidden', String(open));
});
document.addEventListener('click', (e)=>{
  if(!menuDropdown.contains(e.target) && e.target !== menuBtn) {
    menuDropdown.style.display = 'none';
    menuBtn.setAttribute('aria-expanded','false');
    menuDropdown.setAttribute('aria-hidden','true');
  }
});
menuItems.forEach(mi=>{
  mi.addEventListener('click', ()=> {
    const page = mi.getAttribute('data-page');
    showTab(page);
    menuDropdown.style.display = 'none';
  });
});
function showTab(tabId){
  document.querySelectorAll('.tab-content').forEach(s=> s.style.display = 'none');
  const el = document.getElementById(tabId);
  if(el) el.style.display = 'block';
  window.scrollTo({top:0,behavior:'smooth'});
  if(tabId === 'tab-rep') renderReports();
}

/* ===== helpers ===== */
function now(){ return new Date().toLocaleString(); }
function findProduct(name){ if(!name) return null; return state.inventory.find(i => i.item.toLowerCase() === name.trim().toLowerCase()); }
function logInv(action,item,qty){ state.invLog.push({ action,item,qty,date: now() }); saveState(); renderInvLog(); }

/* ===== Inventory rendering & hits (merged with log) ===== */
function renderInventory(filter=''){
  tableInventoryBody.innerHTML = '';
  const q = (filter||'').toLowerCase();
  state.inventory.forEach(prod=>{
    if(q && !prod.item.toLowerCase().includes(q)) return;
    // get last 3 ops for this product
    const ops = state.invLog.filter(l=> l.item.toLowerCase() === prod.item.toLowerCase()).slice(-3).reverse();
    const opsHtml = ops.length ? ops.map(o=>`${o.action} (${o.qty}) — ${o.date.split(',')[0]}`).join('<br/>') : '<span class="small">لا عمليات</span>';
    const status = prod.qty <= state.lowThreshold ? 'قليل' : 'جيد';
    const tr = document.createElement('tr');
    tr.classList.add('clickable');
    tr.setAttribute('data-item', prod.item);
    tr.innerHTML = `<td style="text-align:right">${prod.item}</td><td>${prod.qty}</td><td>${prod.price.toFixed(2)}</td><td style="text-align:left">${opsHtml}</td><td>${status}</td>`;
    // when click row -> prefills sale select and opens Out tab
    tr.addEventListener('click', ()=> {
      // open Out tab and select product
      showTab('tab-sale');
      renderSaleList(); // ensure list filled
      // select the option
      const sel = document.getElementById('saleSelect');
      for(let i=0;i<sel.options.length;i++){ if(sel.options[i].value === prod.item){ sel.selectedIndex = i; sel.onchange && sel.onchange(); break; } }
      window.scrollTo({top:0,behavior:'smooth'});
    });
    if(prod.qty <= state.lowThreshold) tr.classList.add('low');
    tableInventoryBody.appendChild(tr);
  });
  lowThresholdEl.value = state.lowThreshold;
  renderInvLog(); // maintain log table (hidden now but used elsewhere)
}
function renderInvLog(){
  // we'll keep log in memory; not a separate page (merged) — but keep a lightweight table for refer
  // (not shown separately in UI anymore)
  // no-op here or could render hidden debug
}

/* ===== Add new product (manual) ===== */
document.getElementById('btnAddPur').addEventListener('click', ()=>{ /* use same handler as purchases */ });
document.getElementById('btnAddNewProd')?.addEventListener('click', ()=>{}); // no separate newProd in this design (we treat additions as purchases)

/* ===== Purchases / Add (increase inventory) ===== */
document.getElementById('btnAddPur').addEventListener('click', ()=>{
  const name = document.getElementById('purName').value.trim();
  const qty = parseInt(document.getElementById('purQty').value) || 0;
  const price = parseFloat(document.getElementById('purPrice').value) || 0;
  if(!name || qty<=0){ alert('ادخل بيانات صحيحة للإضافة'); return; }
  const total = qty * price; const date = now();
  state.purchases.push({ item:name, qty, price, total, date });
  const prod = findProduct(name);
  if(prod){ prod.qty += qty; if(price>0) prod.price = price; }
  else{ state.inventory.push({ item:name, qty, price }); }
  // record operation in invLog (addition)
  state.invLog.push({ action:'إضافة', item:name, qty, date });
  saveState(); renderPurchases(); renderInventory(searchInventory.value.trim()); renderSaleList(); renderReports();
  document.getElementById('purName').value=''; document.getElementById('purQty').value='1'; document.getElementById('purPrice').value='0';
});
function renderPurchases(){
  tablePurchasesBody.innerHTML = '';
  state.purchases.slice().reverse().forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.item}</td><td>${p.qty}</td><td>${p.price.toFixed(2)}</td><td>${p.total.toFixed(2)}</td><td>${p.date}</td>`;
    tablePurchasesBody.appendChild(tr);
  });
}

/* ===== Out (decrease inventory) ===== */
document.getElementById('btnAddSale').addEventListener('click', ()=>{
  const selected = document.getElementById('saleSelect').value;
  const qty = parseInt(document.getElementById('saleQty').value) || 0;
  if(!selected || qty<=0){ alert('اختر منتجًا وحدد كمية صحيحة'); return; }
  const prod = findProduct(selected);
  if(!prod){ alert('المنتج غير موجود'); return; }
  if(prod.qty < qty){ alert('الكمية المطلوبة أكبر من المخزون'); return; }
  const price = prod.price || 0;
  const total = qty * price; const date = now();
  state.sales.push({ item:prod.item, qty, price, total, date });
  prod.qty -= qty;
  // record operation
  state.invLog.push({ action:'منصرف', item:prod.item, qty, date });
  saveState(); renderSales(); renderInventory(searchInventory.value.trim()); renderSaleList(); renderReports();
  document.getElementById('saleQty').value='1'; document.getElementById('salePrice').value='';
});
function renderSales(){
  tableSalesBody.innerHTML = '';
  state.sales.slice().reverse().forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.item}</td><td>${s.qty}</td><td>${s.price.toFixed(2)}</td><td>${s.total.toFixed(2)}</td><td>${s.date}</td>`;
    tableSalesBody.appendChild(tr);
  });
}

/* sale select + filter + click sets price */
function renderSaleList(filter=''){
  const sel = document.getElementById('saleSelect');
  sel.innerHTML = '';
  state.inventory.forEach(p=>{
    if(filter && !p.item.toLowerCase().includes(filter.toLowerCase())) return;
    const opt = document.createElement('option');
    opt.value = p.item; opt.textContent = `${p.item} — (${p.qty})`;
    sel.appendChild(opt);
  });
  sel.onchange = ()=> {
    const p = findProduct(sel.value);
    document.getElementById('salePrice').value = p ? p.price.toFixed(2) : '';
  };
  if(sel.options.length>0){ sel.selectedIndex = 0; sel.onchange(); } else { document.getElementById('salePrice').value=''; }
}
document.getElementById('saleFilter').addEventListener('input', (e)=> renderSaleList(e.target.value.trim()));

/* ===== Expenses ===== */
document.getElementById('btnAddExp').addEventListener('click', ()=>{
  const desc = document.getElementById('expDesc').value.trim();
  const amount = parseFloat(document.getElementById('expAmount').value) || 0;
  if(!desc || amount<=0){ alert('ادخل بيانات صحيحة للمصروف'); return; }
  const date = now();
  state.expenses.push({ desc, amount, date });
  saveState(); renderExpenses(); renderReports();
  document.getElementById('expDesc').value=''; document.getElementById('expAmount').value='';
});
function renderExpenses(){
  tableExpensesBody.innerHTML = '';
  state.expenses.slice().reverse().forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.desc}</td><td>${e.amount.toFixed(2)}</td><td>${e.date}</td>`;
    tableExpensesBody.appendChild(tr);
  });
}

/* ===== Reports render ===== */
function renderReports(){
  const sumSales = state.sales.reduce((s,x)=>s + (x.total||0), 0);
  const sumPurchases = state.purchases.reduce((s,x)=>s + (x.total||0), 0);
  const sumExpenses = state.expenses.reduce((s,x)=>s + (x.amount||0), 0);
  document.getElementById('sumSales').textContent = sumSales.toFixed(2);
  document.getElementById('sumPurchases').textContent = sumPurchases.toFixed(2);
  document.getElementById('sumExpenses').textContent = sumExpenses.toFixed(2);
  document.getElementById('netProfit').textContent = (sumSales - sumPurchases - sumExpenses).toFixed(2);

  repSalesBody.innerHTML = '';
  state.sales.slice().reverse().forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.item}</td><td>${s.qty}</td><td>${s.price.toFixed(2)}</td><td>${s.total.toFixed(2)}</td><td>${s.date}</td>`;
    repSalesBody.appendChild(tr);
  });
  repPurchasesBody.innerHTML = '';
  state.purchases.slice().reverse().forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.item}</td><td>${p.qty}</td><td>${p.price.toFixed(2)}</td><td>${p.total.toFixed(2)}</td><td>${p.date}</td>`;
    repPurchasesBody.appendChild(tr);
  });
  repExpensesBody.innerHTML = '';
  state.expenses.slice().reverse().forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.desc}</td><td>${e.amount.toFixed(2)}</td><td>${e.date}</td>`;
    repExpensesBody.appendChild(tr);
  });
}

/* ===== Export Excel & PDF ===== */
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  try{
    const wb = XLSX.utils.book_new();
    const invData = state.inventory.map(i=>({الصنف:i.item, الكمية:i.qty, سعر_البيع:i.price}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invData), 'المخزون');
    const salesData = state.sales.map(s=>({الصنف:s.item, الكمية:s.qty, سعر_الوحدة:s.price, الاجمالي:s.total, التاريخ:s.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesData), 'المنصرفات');
    const purData = state.purchases.map(p=>({الصنف:p.item, الكمية:p.qty, سعر_الوحدة:p.price, الاجمالي:p.total, التاريخ:p.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(purData), 'الإضافات');
    const expData = state.expenses.map(e=>({الوصف:e.desc, المبلغ:e.amount, التاريخ:e.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expData), 'المصروفات');
    const logData = state.invLog.map(l=>({العملية:l.action, الصنف:l.item, الكمية:l.qty, التاريخ:l.date}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(logData), 'سجل_المخزون');
    XLSX.writeFile(wb, 'تقرير_المخزن.xlsx');
  } catch(err){
    console.error(err); alert('فشل إنشاء ملف Excel');
  }
});

document.getElementById('exportPdfBtn').addEventListener('click', ()=>{
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    doc.setFontSize(14);
    doc.text('تقرير المخزن', 40, 40);
    doc.setFontSize(10);
    doc.text(`التاريخ: ${new Date().toLocaleString()}`, 40, 60);
    const sumSales = state.sales.reduce((s,x)=>s + (x.total||0), 0);
    const sumPurchases = state.purchases.reduce((s,x)=>s + (x.total||0), 0);
    const sumExpenses = state.expenses.reduce((s,x)=>s + (x.amount||0), 0);
    const profit = sumSales - sumPurchases - sumExpenses;
    doc.text(`إجمالي المنصرفات: ${sumSales.toFixed(2)}`, 40, 90);
    doc.text(`إجمالي الإضافات: ${sumPurchases.toFixed(2)}`, 40, 106);
    doc.text(`إجمالي المصروفات: ${sumExpenses.toFixed(2)}`, 40, 122);
    doc.text(`صافي الربح: ${profit.toFixed(2)}`, 40, 138);
    const salesRows = state.sales.slice().reverse().slice(0,80).map(s=>[s.item, s.qty.toString(), s.price.toFixed(2), s.total.toFixed(2), s.date]);
    doc.autoTable({ startY: 160, head:[['الصنف','الكمية','سعر الوحدة','الإجمالي','التاريخ']], body: salesRows, styles:{fontSize:9} });
    doc.save('تقرير_المخزن.pdf');
  } catch(err){
    console.error(err); alert('فشل إنشاء PDF');
  }
});

/* ===== UI interactions & init ===== */
document.getElementById('lowThreshold').addEventListener('change', ()=>{
  state.lowThreshold = parseInt(document.getElementById('lowThreshold').value) || 0; saveState(); renderInventory();
});
document.getElementById('searchInventory').addEventListener('input', (e)=> renderInventory(e.target.value.trim()));
document.getElementById('clearSearchInv').addEventListener('click', ()=>{ document.getElementById('searchInventory').value=''; renderInventory(); });
document.getElementById('refreshInv').addEventListener('click', ()=> renderAll());
document.getElementById('saleFilter').addEventListener('input', (e)=> renderSaleList(e.target.value.trim()));

/* save periodically */
setInterval(()=> saveState(), 3000);

/* initial render */
function renderAll(){
  renderInventory();
  renderPurchases();
  renderSales();
  renderExpenses();
  renderReports();
  renderSaleList();
}
renderAll();

/* keyboard: close menu on Esc */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ menuDropdown.style.display = 'none'; menuBtn.setAttribute('aria-expanded','false'); } });

</script>
</body>
</html>